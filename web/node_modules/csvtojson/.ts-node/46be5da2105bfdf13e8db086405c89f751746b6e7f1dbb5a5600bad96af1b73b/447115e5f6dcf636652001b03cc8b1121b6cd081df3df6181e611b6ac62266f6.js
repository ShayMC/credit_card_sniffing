"use strict";
var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
var stream_1 = require("stream");
var Parameters_1 = require("./Parameters");
var ParseRuntime_1 = require("./ParseRuntime");
var bluebird_1 = __importDefault(require("bluebird"));
var ProcessorLocal_1 = require("./ProcessorLocal");
var Result_1 = require("./Result");
var Converter = /** @class */ (function (_super) {
    __extends(Converter, _super);
    function Converter(param, options) {
        if (options === void 0) { options = {}; }
        var _this = _super.call(this, options) || this;
        _this.options = options;
        _this.params = Parameters_1.mergeParams(param);
        _this.runtime = ParseRuntime_1.initParseRuntime(_this);
        _this.result = new Result_1.Result(_this);
        // if (this.params.fork) {
        //   this.processor = new ProcessorFork(this);
        // } else {
        _this.processor = new ProcessorLocal_1.ProcessorLocal(_this);
        // }
        _this.once("error", function (err) {
            // console.log("BBB");
            setTimeout(function () {
                _this.result.processError(err);
                _this.emit("done", err);
            }, 0);
        });
        _this.once("done", function () {
            _this.processor.destroy();
        });
        return _this;
    }
    Converter.prototype.preRawData = function (onRawData) {
        this.runtime.preRawDataHook = onRawData;
        return this;
    };
    Converter.prototype.preFileLine = function (onFileLine) {
        this.runtime.preFileLineHook = onFileLine;
        return this;
    };
    Converter.prototype.subscribe = function (onNext, onError, onCompleted) {
        this.parseRuntime.subscribe = {
            onNext: onNext,
            onError: onError,
            onCompleted: onCompleted
        };
        return this;
    };
    Converter.prototype.fromFile = function (filePath, options) {
        var _this = this;
        var fs = require("fs");
        // var rs = null;
        // this.wrapCallback(cb, function () {
        //   if (rs && rs.destroy) {
        //     rs.destroy();
        //   }
        // });
        fs.exists(filePath, function (exist) {
            if (exist) {
                var rs = fs.createReadStream(filePath, options);
                rs.pipe(_this);
            }
            else {
                _this.emit('error', new Error("File does not exist. Check to make sure the file path to your csv is correct."));
            }
        });
        return this;
    };
    Converter.prototype.fromStream = function (readStream) {
        readStream.pipe(this);
        return this;
    };
    Converter.prototype.fromString = function (csvString) {
        var csv = csvString.toString();
        var read = new stream_1.Readable();
        var idx = 0;
        read._read = function (size) {
            if (idx >= csvString.length) {
                this.push(null);
            }
            else {
                var str = csvString.substr(idx, size);
                this.push(str);
                idx += size;
            }
        };
        return this.fromStream(read);
    };
    Converter.prototype.then = function (onfulfilled, onrejected) {
        var _this = this;
        return new bluebird_1.default(function (resolve, reject) {
            _this.parseRuntime.then = {
                onfulfilled: function (value) {
                    if (onfulfilled) {
                        resolve(onfulfilled(value));
                    }
                    else {
                        resolve(value);
                    }
                },
                onrejected: function (err) {
                    if (onrejected) {
                        resolve(onrejected(err));
                    }
                    else {
                        reject(err);
                    }
                }
            };
        });
    };
    Object.defineProperty(Converter.prototype, "parseParam", {
        get: function () {
            return this.params;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(Converter.prototype, "parseRuntime", {
        get: function () {
            return this.runtime;
        },
        enumerable: true,
        configurable: true
    });
    Converter.prototype._transform = function (chunk, encoding, cb) {
        var _this = this;
        this.processor.process(chunk)
            .then(function (result) {
            // console.log(result);
            if (result.length > 0) {
                _this.runtime.started = true;
                return _this.result.processResult(result);
            }
        })
            .then(function () {
            _this.emit("drained");
            cb();
        }, function (error) {
            _this.runtime.hasError = true;
            _this.runtime.error = error;
            _this.emit("error", error);
            cb();
        });
    };
    Converter.prototype._flush = function (cb) {
        var _this = this;
        this.processor.flush()
            .then(function (data) {
            if (data.length > 0) {
                return _this.result.processResult(data);
            }
        })
            .then(function () {
            _this.processEnd(cb);
        }, function (err) {
            _this.emit("error", err);
            cb();
        });
    };
    Converter.prototype.processEnd = function (cb) {
        this.result.endProcess();
        this.emit("done");
        cb();
    };
    Object.defineProperty(Converter.prototype, "parsedLineNumber", {
        get: function () {
            return this.runtime.parsedLineNumber;
        },
        enumerable: true,
        configurable: true
    });
    return Converter;
}(stream_1.Transform));
exports.Converter = Converter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL1VzZXJzL2t4aWFuZy93b3JrL3Byb2plY3RzL2NzdjJqc29uL3NyYy9Db252ZXJ0ZXIudHMiLCJzb3VyY2VzIjpbIi9Vc2Vycy9reGlhbmcvd29yay9wcm9qZWN0cy9jc3YyanNvbi9zcmMvQ29udmVydGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUFBLGlDQUErRDtBQUMvRCwyQ0FBMEQ7QUFDMUQsK0NBQWdFO0FBQ2hFLHNEQUF5QjtBQVF6QixtREFBa0Q7QUFDbEQsbUNBQWtDO0FBR2xDO0lBQStCLDZCQUFTO0lBdUZ0QyxtQkFBWSxLQUE4QixFQUFTLE9BQThCO1FBQTlCLHdCQUFBLEVBQUEsWUFBOEI7UUFBakYsWUFDRSxrQkFBTSxPQUFPLENBQUMsU0F1QmY7UUF4QmtELGFBQU8sR0FBUCxPQUFPLENBQXVCO1FBRS9FLEtBQUksQ0FBQyxNQUFNLEdBQUcsd0JBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqQyxLQUFJLENBQUMsT0FBTyxHQUFHLCtCQUFnQixDQUFDLEtBQUksQ0FBQyxDQUFDO1FBQ3RDLEtBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxlQUFNLENBQUMsS0FBSSxDQUFDLENBQUM7UUFDL0IsMEJBQTBCO1FBQzFCLDhDQUE4QztRQUM5QyxXQUFXO1FBQ1gsS0FBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLCtCQUFjLENBQUMsS0FBSSxDQUFDLENBQUM7UUFDMUMsSUFBSTtRQUNKLEtBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQUMsR0FBUTtZQUMxQixzQkFBc0I7WUFFdEIsVUFBVSxDQUFDO2dCQUNULEtBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM5QixLQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN6QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFUixDQUFDLENBQUMsQ0FBQztRQUNILEtBQUksQ0FBQyxJ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QixLQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMxQixFQUFFLEVBQUUsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUNELDBCQUFNLEdBQU4sVUFBTyxFQUFZO1FBQW5CLGlCQWNDO1FBYkMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUU7YUFDbkIsSUFBSSxDQUFDLFVBQUMsSUFBSTtZQUNULElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7Z0JBRW5CLE9BQU8sS0FBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDeEM7UUFDSCxDQUFDLENBQUM7YUFDRCxJQUFJLENBQUM7WUFDSixLQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3RCLENBQUMsRUFBRSxVQUFDLEdBQUc7WUFDTCxLQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN4QixFQUFFLEVBQUUsQ0FBQztRQUNQLENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQUNPLDhCQUFVLEdBQWxCLFVBQW1CLEVBQUU7UUFDbkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUN6QixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xCLEVBQUUsRUFBRSxDQUFDO0lBQ1AsQ0FBQztJQUNELHNCQUFJLHVDQUFnQjthQUFwQjtZQUNFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQztRQUN2QyxDQUFDOzs7T0FBQTtJQUNILGdCQUFDO0FBQUQsQ0FBQyxBQTNKRCxDQUErQixrQkFBUyxHQTJKdkM7QUEzSlksOEJBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUcmFuc2Zvcm0sIFRyYW5zZm9ybU9wdGlvbnMsIFJlYWRhYmxlIH0gZnJvbSBcInN0cmVhbVwiO1xuaW1wb3J0IHsgQ1NWUGFyc2VQYXJhbSwgbWVyZ2VQYXJhbXMgfSBmcm9tIFwiLi9QYXJhbWV0ZXJzXCI7XG5pbXBvcnQgeyBQYXJzZVJ1bnRpbWUsIGluaXRQYXJzZVJ1bnRpbWUgfSBmcm9tIFwiLi9QYXJzZVJ1bnRpbWVcIjtcbmltcG9ydCBQIGZyb20gXCJibHVlYmlyZFwiO1xuaW1wb3J0IHsgc3RyaW5nVG9MaW5lcyB9IGZyb20gXCIuL2ZpbGVsaW5lXCI7XG5pbXBvcnQgeyBtYXAgfSBmcm9tIFwibG9kYXNoL21hcFwiO1xuaW1wb3J0IHsgUm93U3BsaXQsIFJvd1NwbGl0UmVzdWx0IH0gZnJvbSBcIi4vcm93U3BsaXRcIjtcbmltcG9ydCBnZXRFb2wgZnJvbSBcIi4vZ2V0RW9sXCI7XG5pbXBvcnQgbGluZVRvSnNvbiwgeyBKU09OUmVzdWx0IH0gZnJvbSBcIi4vbGluZVRvSnNvblwiO1xuaW1wb3J0IHsgUHJvY2Vzc29yLCBQcm9jZXNzTGluZVJlc3VsdCB9IGZyb20gXCIuL1Byb2Nlc3NvclwiO1xuaW1wb3J0IHsgUHJvY2Vzc29yRm9yayB9IGZyb20gXCIuL1Byb2Nlc3NGb3JrXCI7XG5pbXBvcnQgeyBQcm9jZXNzb3JMb2NhbCB9IGZyb20gXCIuL1Byb2Nlc3NvckxvY2FsXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi9SZXN1bHRcIjtcbmltcG9ydCBDU1ZFcnJvciBmcm9tIFwiLi9DU1ZFcnJvclwiO1xuaW1wb3J0IHsgYnVmRnJvbVN0cmluZyB9IGZyb20gXCIuL3V0aWxcIjtcbmV4cG9ydCBjbGFzcyBDb252ZXJ0ZXIgZXh0ZW5kcyBUcmFuc2Zvcm0ge1xuICBwcmVSYXdEYXRhKG9uUmF3RGF0YTogUHJlUmF3RGF0YUNhbGxiYWNrKTogQ29udmVydGVyIHtcbiAgICB0aGlzLnJ1bnRpbWUucHJlUmF3RGF0YUhvb2sgPSBvblJhd0RhdGE7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbiAgcHJlRmlsZUxpbmUob25GaWxlTGluZTogUHJlRmlsZUxpbmVDYWxsYmFjayk6IENvbnZlcnRlciB7XG4gICAgdGhpcy5ydW50aW1lLnByZUZpbGVMaW5lSG9vayA9IG9uRmlsZUxpbmU7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbiAgc3Vic2NyaWJlKFxuICAgIG9uTmV4dD86IChkYXRhOiBhbnksIGxpbmVOdW1iZXI6IG51bWJlcikgPT4gdm9pZCB8IFByb21pc2VMaWtlPHZvaWQ+LFxuICAgIG9uRXJyb3I/OiAoZXJyOiBDU1ZFcnJvcikgPT4gdm9pZCxcbiAgICBvbkNvbXBsZXRlZD86ICgpID0+IHZvaWQpOiBDb252ZXJ0ZXIge1xuICAgIHRoaXMucGFyc2VSdW50aW1lLnN1YnNjcmliZSA9IHtcbiAgICAgIG9uTmV4dCxcbiAgICAgIG9uRXJyb3IsXG4gICAgICBvbkNvbXBsZXRlZFxuICAgIH1cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBmcm9tRmlsZShmaWxlUGF0aDogc3RyaW5nLCBvcHRpb25zPzogc3RyaW5nIHwgQ3JlYXRlUmVhZFN0cmVhbU9wdGlvbiB8IHVuZGVmaW5lZCk6IENvbnZlcnRlciB7XG4gICAgY29uc3QgZnMgPSByZXF1aXJlKFwiZnNcIik7XG4gICAgLy8gdmFyIHJzID0gbnVsbDtcbiAgICAvLyB0aGlzLndyYXBDYWxsYmFjayhjYiwgZnVuY3Rpb24gKCkge1xuICAgIC8vICAgaWYgKHJzICYmIHJzLmRlc3Ryb3kpIHtcbiAgICAvLyAgICAgcnMuZGVzdHJveSgpO1xuICAgIC8vICAgfVxuICAgIC8vIH0pO1xuICAgIGZzLmV4aXN0cyhmaWxlUGF0aCwgKGV4aXN0KSA9PiB7XG4gICAgICBpZiAoZXhpc3QpIHtcbiAgICAgICAgY29uc3QgcnMgPSBmcy5jcmVhdGVSZWFkU3RyZWFtKGZpbGVQYXRoLCBvcHRpb25zKTtcbiAgICAgICAgcnMucGlwZSh0aGlzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuZW1pdCgnZXJyb3InLCBuZXcgRXJyb3IoXCJGaWxlIGRvZXMgbm90IGV4aXN0LiBDaGVjayB0byBtYWtlIHN1cmUgdGhlIGZpbGUgcGF0aCB0byB5b3VyIGNzdiBpcyBjb3JyZWN0LlwiKSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cbiAgZnJvbVN0cmVhbShyZWFkU3RyZWFtOiBSZWFkYWJsZSk6IENvbnZlcnRlciB7XG4gICAgcmVhZFN0cmVhbS5waXBlKHRoaXMpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG4gIGZyb21TdHJpbmcoY3N2U3RyaW5nOiBzdHJpbmcpOiBDb252ZXJ0ZXIge1xuICAgIGNvbnN0IGNzdiA9IGNzdlN0cmluZy50b1N0cmluZygpO1xuICAgIGNvbnN0IHJlYWQgPSBuZXcgUmVhZGFibGUoKTtcbiAgICBsZXQgaWR4ID0gMDtcbiAgICByZWFkLl9yZWFkID0gZnVuY3Rpb24gKHNpemUpIHtcbiAgICAgIGlmIChpZHggPj0gY3N2U3RyaW5nLmxlbmd0aCkge1xuICAgICAgICB0aGlzLnB1c2gobnVsbCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBzdHIgPSBjc3ZTdHJpbmcuc3Vic3RyKGlkeCwgc2l6ZSk7XG4gICAgICAgIHRoaXMucHVzaChzdHIpO1xuICAgICAgICBpZHggKz0gc2l6ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZnJvbVN0cmVhbShyZWFkKTtcbiAgfVxuICB0aGVuPFRSZXN1bHQxID0gYW55W10sIFRSZXN1bHQyID0gbmV2ZXI+KG9uZnVsZmlsbGVkPzogKHZhbHVlOiBhbnlbXSkgPT4gVFJlc3VsdDEgfCBQcm9taXNlTGlrZTxUUmVzdWx0MT4sIG9ucmVqZWN0ZWQ/OiAocmVhc29uOiBhbnkpID0+IFRSZXN1bHQyIHwgUHJvbWlzZUxpa2U8VFJlc3VsdDI+KTogUHJvbWlzZUxpa2U8VFJlc3VsdDEgfCBUUmVzdWx0Mj4ge1xuICAgIHJldHVybiBuZXcgUCgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLnBhcnNlUnVudGltZS50aGVuID0ge1xuICAgICAgICBvbmZ1bGZpbGxlZDogKHZhbHVlOiBhbnlbXSkgPT4ge1xuICAgICAgICAgIGlmIChvbmZ1bGZpbGxlZCkge1xuICAgICAgICAgICAgcmVzb2x2ZShvbmZ1bGZpbGxlZCh2YWx1ZSkpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKHZhbHVlIGFzIGFueSk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBvbnJlamVjdGVkOiAoZXJyOiBFcnJvcikgPT4ge1xuICAgICAgICAgIGlmIChvbnJlamVjdGVkKSB7XG4gICAgICAgICAgICByZXNvbHZlKG9ucmVqZWN0ZWQoZXJyKSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIHB1YmxpYyBnZXQgcGFyc2VQYXJhbSgpOiBDU1ZQYXJzZVBhcmFtIHtcbiAgICByZXR1cm4gdGhpcy5wYXJhbXM7XG4gIH1cbiAgcHVibGljIGdldCBwYXJzZVJ1bnRpbWUoKTogUGFyc2VSdW50aW1lIHtcbiAgICByZXR1cm4gdGhpcy5ydW50aW1lO1xuICB9XG4gIHByaXZhdGUgcGFyYW1zOiBDU1ZQYXJzZVBhcmFtO1xuICBwcml2YXRlIHJ1bnRpbWU6IFBhcnNlUnVudGltZTtcbiAgcHJpdmF0ZSBwcm9jZXNzb3I6IFByb2Nlc3NvcjtcbiAgcHJpdmF0ZSByZXN1bHQ6IFJlc3VsdDtcbiAgY29uc3RydWN0b3IocGFyYW0/OiBQYXJ0aWFsPENTVlBhcnNlUGFyYW0+LCBwdWJsaWMgb3B0aW9uczogVHJhbnNmb3JtT3B0aW9ucyA9IHt9KSB7XG4gICAgc3VwZXIob3B0aW9ucyk7XG4gICAgdGhpcy5wYXJhbXMgPSBtZXJnZVBhcmFtcyhwYXJhbSk7XG4gICAgdGhpcy5ydW50aW1lID0gaW5pdFBhcnNlUnVudGltZSh0aGlzKTtcbiAgICB0aGlzLnJlc3VsdCA9IG5ldyBSZXN1bHQodGhpcyk7XG4gICAgLy8gaWYgKHRoaXMucGFyYW1zLmZvcmspIHtcbiAgICAvLyAgIHRoaXMucHJvY2Vzc29yID0gbmV3IFByb2Nlc3NvckZvcmsodGhpcyk7XG4gICAgLy8gfSBlbHNlIHtcbiAgICB0aGlzLnByb2Nlc3NvciA9IG5ldyBQcm9jZXNzb3JMb2NhbCh0aGlzKTtcbiAgICAvLyB9XG4gICAgdGhpcy5vbmNlKFwiZXJyb3JcIiwgKGVycjogYW55KSA9PiB7XG4gICAgICAvLyBjb25zb2xlLmxvZyhcIkJCQlwiKTtcblxuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMucmVzdWx0LnByb2Nlc3NFcnJvcihlcnIpO1xuICAgICAgICB0aGlzLmVtaXQoXCJkb25lXCIsIGVycik7XG4gICAgICB9LCAwKTtcblxuICAgIH0pO1xuICAgIHRoaXMub25jZShcImRvbmVcIiwgKCkgPT4ge1xuICAgICAgdGhpcy5wcm9jZXNzb3IuZGVzdHJveSgpO1xuICAgIH0pXG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuICBfdHJhbnNmb3JtKGNodW5rOiBhbnksIGVuY29kaW5nOiBzdHJpbmcsIGNiOiBGdW5jdGlvbikge1xuICAgIHRoaXMucHJvY2Vzc29yLnByb2Nlc3MoY2h1bmspXG4gICAgICAudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gICAgICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMucnVudGltZS5zdGFydGVkID0gdHJ1ZTtcblxuICAgICAgICAgIHJldHVybiB0aGlzLnJlc3VsdC5wcm9jZXNzUmVzdWx0KHJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdChcImRyYWluZWRcIik7XG4gICAgICAgIGNiKCk7XG4gICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgdGhpcy5ydW50aW1lLmhhc0Vycm9yID0gdHJ1ZTtcbiAgICAgICAgdGhpcy5ydW50aW1lLmVycm9yID0gZXJyb3I7XG4gICAgICAgIHRoaXMuZW1pdChcImVycm9yXCIsIGVycm9yKTtcbiAgICAgICAgY2IoKTtcbiAgICAgIH0pO1xuICB9XG4gIF9mbHVzaChjYjogRnVuY3Rpb24pIHtcbiAgICB0aGlzLnByb2Nlc3Nvci5mbHVzaCgpXG4gICAgICAudGhlbigoZGF0YSkgPT4ge1xuICAgICAgICBpZiAoZGF0YS5sZW5ndGggPiAwKSB7XG5cbiAgICAgICAgICByZXR1cm4gdGhpcy5yZXN1bHQucHJvY2Vzc1Jlc3VsdChkYXRhKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgdGhpcy5wcm9jZXNzRW5kKGNiKTtcbiAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgdGhpcy5lbWl0KFwiZXJyb3JcIiwgZXJyKTtcbiAgICAgICAgY2IoKTtcbiAgICAgIH0pXG4gIH1cbiAgcHJpdmF0ZSBwcm9jZXNzRW5kKGNiKSB7XG4gICAgdGhpcy5yZXN1bHQuZW5kUHJvY2VzcygpO1xuICAgIHRoaXMuZW1pdChcImRvbmVcIik7XG4gICAgY2IoKTtcbiAgfVxuICBnZXQgcGFyc2VkTGluZU51bWJlcigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnJ1bnRpbWUucGFyc2VkTGluZU51bWJlcjtcbiAgfVxufVxuZXhwb3J0IGludGVyZmFjZSBDcmVhdGVSZWFkU3RyZWFtT3B0aW9uIHtcbiAgZmxhZ3M/OiBzdHJpbmc7XG4gIGVuY29kaW5nPzogc3RyaW5nO1xuICBmZD86IG51bWJlcjtcbiAgbW9kZT86IG51bWJlcjtcbiAgYXV0b0Nsb3NlPzogYm9vbGVhbjtcbiAgc3RhcnQ/OiBudW1iZXI7XG4gIGVuZD86IG51bWJlcjtcbiAgaGlnaFdhdGVyTWFyaz86IG51bWJlcjtcbn1cbmV4cG9ydCB0eXBlIENhbGxCYWNrID0gKGVycjogRXJyb3IsIGRhdGE6IEFycmF5PGFueT4pID0+IHZvaWQ7XG5cblxuZXhwb3J0IHR5cGUgUHJlRmlsZUxpbmVDYWxsYmFjayA9IChsaW5lOiBzdHJpbmcsIGxpbmVOdW1iZXI6IG51bWJlcikgPT4gc3RyaW5nIHwgUHJvbWlzZUxpa2U8c3RyaW5nPjtcbmV4cG9ydCB0eXBlIFByZVJhd0RhdGFDYWxsYmFjayA9IChjc3ZTdHJpbmc6IHN0cmluZykgPT4gc3RyaW5nIHwgUHJvbWlzZUxpa2U8c3RyaW5nPjtcbiJdfQ==